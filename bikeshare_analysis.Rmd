---
title: "Cyclistic Ride Behavior Analysis"
author: "Thien"
date: "2025-12-10"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Load library
```{r}
install.packages("tidyverse")
install.packages("skimr")
install.packages("scales")
```

```{r}
library(tidyverse)
library(skimr)
library(scales)
```

#Load datasets
```{r}
data_202307 <- read.csv("data/202307-divvy-tripdata.csv")
data_202308 <- read.csv("data/202308-divvy-tripdata.csv")
data_202309 <- read.csv("data/202309-divvy-tripdata.csv")
data_202310 <- read.csv("data/202310-divvy-tripdata.csv")
data_202311 <- read.csv("data/202311-divvy-tripdata.csv")
data_202312 <- read.csv("data/202312-divvy-tripdata.csv")
data_202401 <- read.csv("data/202401-divvy-tripdata.csv")
data_202402 <- read.csv("data/202402-divvy-tripdata.csv")
data_202403 <- read.csv("data/202403-divvy-tripdata.csv")
data_202404 <- read.csv("data/202404-divvy-tripdata.csv")
data_202405 <- read.csv("data/202405-divvy-tripdata.csv")
data_202406 <- read.csv("data/202406-divvy-tripdata.csv")
```

#Combine all dataset into one
```{r}

all_trips <- bind_rows(
  data_202307,
  data_202308,
  data_202309,
  data_202310,
  data_202311,
  data_202312,
  data_202401,
  data_202402,
  data_202403,
  data_202404,
  data_202405,
  data_202406
)
```

```{r}
summary(all_trips)
```
```{r}
skim_without_charts(all_trips)
```


```{r}
#Remove bad rows in started_at and ended_at
all_trips <- all_trips %>% 
  filter(!is.na(started_at), !is.na(ended_at)) %>% 
  mutate(ride_length_min = as.numeric(difftime(ended_at, started_at, units = "mins")),
         ride_length_min = round(ride_length_min, 2) ) %>% 
  filter(ride_length_min > 0)  # remove negative or zero duration
```

```{r}
#Rows where these are missing or obviously wrong should be removed
all_trips<- all_trips %>% 
  filter(
    !is.na(start_lat), !is.na(start_lng),
    !is.na(end_lat),   !is.na(end_lng)
  )
```


```{r}
all_trips<- all_trips %>% 
  mutate(
    start_station_name = na_if(trimws(start_station_name), ""),
    end_station_name   = na_if(trimws(end_station_name), "")
  )
```

```{r}
# lookup for start stations
start_lookup <- all_trips %>% 
  filter(!is.na(start_station_name)) %>% 
  count(start_lat, start_lng, start_station_name, sort = TRUE) %>% 
  group_by(start_lat, start_lng) %>% 
  slice_max(n, n = 1, with_ties = FALSE) %>% 
  ungroup() %>% 
  select(start_lat, start_lng, start_station_name)

# lookup for end stations
end_lookup <- all_trips %>% 
  filter(!is.na(end_station_name)) %>% 
  count(end_lat, end_lng, end_station_name, sort = TRUE) %>% 
  group_by(end_lat, end_lng) %>% 
  slice_max(n, n = 1, with_ties = FALSE) %>% 
  ungroup() %>% 
  select(end_lat, end_lng, end_station_name)
```

```{r}
# fill start_station_name
all_trips<- all_trips%>% 
  left_join(start_lookup,
            by = c("start_lat", "start_lng"),
            suffix = c("", "_lookup")) %>% 
  mutate(
    start_station_name = coalesce(start_station_name, start_station_name_lookup)
  ) %>% 
  select(-start_station_name_lookup)

# fill end_station_name
all_trips<- all_trips %>% 
  left_join(end_lookup,
            by = c("end_lat", "end_lng"),
            suffix = c("", "_lookup")) %>% 
  mutate(
    end_station_name = coalesce(end_station_name, end_station_name_lookup)
  ) %>% 
  select(-end_station_name_lookup)
```

```{r}
all_trips <- all_trips %>% 
  mutate(
    started_at = ymd_hms(started_at, tz = "America/Chicago"),
    ended_at   = ymd_hms(ended_at,   tz = "America/Chicago")
  )
```

```{r}
all_trips <- all_trips %>% 
  mutate(
    # basic calendar fields
    ride_date    = as.Date(started_at),
    ride_hour    = hour(started_at),                           # 0–23
    ride_weekday = wday(started_at, label = TRUE,              # Mon, Tue, ...
                         abbr  = FALSE, week_start = 1),
    ride_month   = month(started_at, label = TRUE, abbr = TRUE), # Jan, Feb…
    ride_year    = year(started_at),

    # weekend flag (TRUE for Sat / Sun)
    is_weekend   = wday(started_at) %in% c(1, 7),              # 1 = Sun, 7 = Sat

    # season based on month (Northern hemisphere)
    season = case_when(
      month(started_at) %in% c(12, 1, 2) ~ "Winter",
      month(started_at) %in% c(3, 4, 5) ~ "Spring",
      month(started_at) %in% c(6, 7, 8) ~ "Summer",
      TRUE                              ~ "Fall"
    )
  )
```
```{r}
all_trips<- all_trips %>% 
  distinct(ride_id, .keep_all = TRUE)

sum(duplicated(all_trips$ride_id))
```

```{r}
skim_without_charts(all_trips)
```

```{r}
summary(all_trips)
```

```{r}
write.csv(
  all_trips,
  file = "data/all_trips_cleaned.csv",
  row.names = FALSE
)
```

```{r}
all_trips_cleaned <- read.csv("data/all_trips_cleaned.csv")
```

```{r}
count_by_member <- all_trips_cleaned %>%
  count(member_casual, name = "total_rides")

ggplot(count_by_member,
       aes(x = member_casual, y = total_rides, fill = member_casual)) +
  geom_col(width = 0.6) +
  geom_text(aes(label = comma(total_rides)),   # show real numbers on bars
            vjust = -0.3, size = 4) +
  scale_y_continuous(labels = comma, # turn off scientific notation
                     expand = expansion(mult = c(0, 0.1))) +
  scale_fill_manual(values = c("casual" = "orange",
                               "member" = "steelblue")) +
  labs(title = "Number between Members and Casuals",
    x = "Rider type", 
    y = "Number of rides", 
    fill = NULL) +
  theme_minimal()
```

```{r}
bike_type_counts <- all_trips_cleaned %>%
  group_by(member_casual)%>% 
  count(rideable_type, name = "total_rides")

ggplot(bike_type_counts,
       aes(x = rideable_type, y = total_rides, fill = member_casual)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_text(aes(label = comma(total_rides)),
            position = position_dodge(width = 0.8),
            vjust = -0.3, size = 4) +
  scale_y_continuous(labels = comma) +
  scale_x_discrete(labels = c(
    "classic_bike"  = "Classic Bike",
    "docked_bike"   = "Docked Bike",
    "electric_bike" = "Electric Bike"
  )) +
  scale_fill_manual(values = c("member" = "steelblue",
                               "casual" = "orange")) +
  labs(
    title = "Frequency of Bike Types Preferred by Riders",
    x = "Bike Type",
    y = "Number of rides",
    fill = "Member Type"
  ) +
  theme_minimal(base_size = 13)
```

→ Immediately shows if members peak around 8–9am & 5–6pm while casuals peak midday or on weekends.
Heatmaps of bike usage by hour and day-of-week are commonly used to reveal temporal patterns in bike-share systems.
Target the weekday from monday - friday to promote who are casual use in this time to help them recognize the benefit of become membership

- Popular ride hours by weekday

```{r}
hour_weekday_counts <- all_trips_cleaned %>%
  # only keep columns we need, and reorder weekdays
  transmute(
    member_casual,
    ride_hour,
    ride_weekday = factor(
      ride_weekday,
      levels = c("Monday", "Tuesday", "Wednesday",
                 "Thursday", "Friday", "Saturday", "Sunday")
    )
  ) %>%
  # create hour groups (ONLY in this new table)
  mutate(
    hour_group = cut(
      ride_hour,
      breaks = c(-1, 5, 9, 13, 17, 21, 23),
      labels = c(
        "00–05 Night",
        "06–09 Morning peak",
        "10–13 Late morning",
        "14–17 Afternoon",
        "18–21 Evening peak",
        "22–23 Late night"
      ),
      ordered_result = TRUE
    )
  ) %>%
  # count rides per weekday × hour_group × membership
  count(member_casual, ride_weekday, hour_group, name = "rides")


ggplot(hour_weekday_counts,
       aes(x = hour_group, y = ride_weekday, fill = rides)) +
  geom_tile(color = "white") +
  scale_fill_gradient(name = "Number of rides",
                      low = "white", high = "orange") +
  facet_wrap(~ member_casual) +
  labs(
    title = "Hour-of-day vs Weekday Ride Intensity (Grouped Hours)",
    x = "Time of day",
    y = "Weekday"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

#Analyze the duration of two user type
two plot some two type of user are commonly use in the same duaration but with the membership can look the user are use longer than the casual user
so can approach the casual use two help them know with this same duration using membership can help them save money
```{r}
duration_data <- all_trips_cleaned %>%
  transmute(
    member_casual,
    ride_length = as.numeric(ride_length_min)
  ) %>%
  filter(
    !is.na(ride_length),
    ride_length > 0,
    ride_length <= 30          # keep rides up to 2 hours
  )

ggplot(duration_data,
       aes(x = ride_length, fill = member_casual)) +
  geom_histogram(
    aes(y = after_stat(count / sum(count))),  # <- convert to proportion
    color = "white",
    bins = 100
  ) +
  facet_wrap(~ member_casual, ncol = 1) +
  scale_fill_manual(values = c(
    "casual" = "orange",
    "member" = "steelblue"
  )) +
  scale_x_continuous(
    limits = c(0, 30),
    breaks = seq(0, 30, by = 5),
    labels = seq(0, 30, by = 5)
  ) +
  scale_y_continuous(
    labels = label_percent(accuracy = 1),     # show 0%, 5%, 10%, ...
    expand = expansion(mult = c(0, 0.02))
  ) +
  labs(
    title = "Distribution of Ride Duration by Member Type",
    x = "Ride duration (minutes)",
    y = "Share of rides (%)",
    fill = "Member Type"
  ) +
  theme_minimal(base_size = 13)
```

```{r}
duration_box_data <- all_trips_cleaned %>%
  transmute(
    member_casual,
    ride_length = as.numeric(ride_length_min)
  ) %>%
  filter(
    !is.na(ride_length),
    ride_length > 0,
    ride_length <= 30    # cap extreme outliers
  )

ggplot(duration_box_data,
       aes(x = member_casual, y = ride_length, fill = member_casual)) +
  geom_boxplot() +
  scale_fill_manual(values = c(
    "casual" = "orange",
    "member" = "steelblue"
  )) +
  labs(
    title = "Ride Duration by Member Type",
    x = "Member Type",
    y = "Ride duration (minutes)",
    fill = "Member Type"
  ) +
  theme_minimal(base_size = 13)

```

```{r}
N_top <- 10   # choose how many top stations you want


top_start_stations_pct <- all_trips_cleaned %>%
  filter(!is.na(start_station_name),
         start_station_name != "") %>%
  count(member_casual, start_station_name, name = "rides") %>%
  group_by(member_casual) %>%
  slice_max(rides, n = N_top, with_ties = FALSE) %>%
  ungroup() %>%
  # add totals and compute percentage
  left_join(count_by_member, by = "member_casual") %>%
  mutate(pct = rides / total_rides)   # pct is 0–1


casual_data <- top_start_stations_pct %>%
  filter(member_casual == "casual")

ggplot(casual_data,
       aes(x = pct,
           y = reorder(start_station_name, pct))) +
  geom_col(fill = "orange") +
  scale_x_continuous(
    labels = percent_format(accuracy = 0.1),  # e.g. 0.5%, 1.0%, ...
    expand = expansion(mult = c(0, .02))
  ) +
  labs(
    title = "Top 10 Start Stations – Casual Riders (Share of Casual Rides)",
    x = "Share of all casual rides",
    y = "Start station"
  ) +
  theme_minimal(base_size = 13)
```


```{r}
member_data <- top_start_stations_pct %>%
  filter(member_casual == "member")

ggplot(member_data,
       aes(x = pct,
           y = reorder(start_station_name, pct))) +
  geom_col(fill = "steelblue") +
  scale_x_continuous(
    labels = percent_format(accuracy = 0.1),
    expand = expansion(mult = c(0, .02))
  ) +
  labs(
    title = "Top 10 Start Stations – Members (Share of Member Rides)",
    x = "Share of all member rides",
    y = "Start station"
  ) +
  theme_minimal(base_size =13)
```